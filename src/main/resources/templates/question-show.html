<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${question.title}">Question Details</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-dark.min.css">

    <!-- Include layout styles first -->
    <th:block th:replace="fragments/layout :: styles"></th:block>

    <style>
        .page-wrapper {
            max-width: 1264px;
            margin: 0 auto !important;
            padding: calc(var(--navbar-height) + 20px) 16px 24px;
            box-sizing: border-box;
        }

        .question-container {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 300px;
            grid-template-areas: "main side";
            gap: 24px;
            width: 100%;
            margin: 0;
            align-items: start;
        }

        .question-main {
            flex: 1;
            min-width: 0; /* CRITICAL FIX: Allow flex item to shrink */
            word-wrap: break-word;
            grid-area: main;
        }

        .question-title {
            font-size: 27px;
            font-weight: 400;
            line-height: 1.35;
            margin: 0 0 16px 0;
            color: #3b4045;
            word-break: break-word;
        }

        .question-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #6a737c;
            padding: 8px 0;
            border-bottom: 1px solid #e3e6e8;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* Question body with voting - side by side */
        .question-body-container {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        /* Left voting column */
        .vote-col {
            width: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 4px;
            user-select: none;
            flex-shrink: 0;
        }

        .vote-button {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 2px solid #bbc0c4;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            margin: 2px 0;
        }

        .vote-button:hover {
            background: #f8f9f9;
        }

        .vote-button svg {
            fill: #848d95;
        }

        .vote-button:hover svg {
            fill: #525960;
        }

        .vote-count {
            margin: 8px 0;
            font-weight: 600;
            font-size: 21px;
            color: #6a737c;
            text-align: center;
        }

        /* Question body content */
        .question-body {
            flex: 1;
            min-width: 0; /* CRITICAL FIX: Allow flex item to shrink */
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Ensure all direct children respect the container */
        .question-body > * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Fix for editor-generated content */
        .question-body .toastui-editor-contents,
        .answer-body .toastui-editor-contents {
            max-width: 100%;
        }

        /* Strengthen image constraints */
        .question-body img,
        .answer-body img {
            max-width: 100% !important;
            width: auto !important;
            height: auto;
            display: block;
            margin: 15px 0;
            border-radius: 4px;
        }

        /* Fix for wide tables */
        .question-body table,
        .answer-body table {
            max-width: 100%;
            overflow-x: auto;
            display: block;
            box-sizing: border-box;
        }

        /* CODE BLOCKS â€” clearer, larger, exact whitespace */
        .question-body pre,
        .answer-body pre {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 16px 18px;
            margin: 12px 0;
            overflow: auto;
            white-space: pre; /* preserve exact spaces & newlines */
            line-height: 1.55;
            font-size: 14px;
            tab-size: 4;
            max-width: 100%;
            box-sizing: border-box;
            font-family: "Fira Code", "Source Code Pro", Consolas, monospace;
        }

        /* Inline code (not inside pre) */
        .question-body code,
        .answer-body code {
            font-family: "Fira Code", "Source Code Pro", Consolas, monospace;
            white-space: pre-wrap;
            background: #f3f4f6;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 12.5px;
            color: #2f3337;
        }

        .question-body pre code,
        .answer-body pre code {
            background: transparent;
            color: inherit;
            padding: 0;
            white-space: pre;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }

        .tag {
            background: #e1ecf4;
            color: #39739d;
            border: 1px solid #cde9fe;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .post-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 12px 0 20px 0;
            flex-wrap: wrap;
        }

        .answers-header {
            font-size: 21px;
            margin: 24px 0 12px 0;
        }

        .answer {
            border-top: 1px solid #e3e6e8;
            padding-top: 16px;
            margin-top: 16px;
        }

        /* Right sidebar styles */
        .sidebar {
            width: 300px;
            flex: 0 0 300px;
            position: sticky;
            top: calc(var(--navbar-height) + 20px);
            height: fit-content;
            max-height: calc(100vh - var(--navbar-height) - 40px);
            overflow-y: auto;
            grid-area: side;
        }

        .card {
            border: 1px solid #e3e6e8;
            border-radius: 6px;
            background: #fff;
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }

        .card h4 {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .card ul {
            padding-left: 18px;
            margin: 0;
        }

        .card li {
            margin: 6px 0;
            line-height: 1.4;
            color: #3b4045;
            font-size: 13px;
        }

        /* Form styling */
        .answer-form {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e3e6e8;
        }

        .answer-form h3 {
            margin-bottom: 16px;
            font-size: 19px;
            color: #3b4045;
        }

        .submit-button {
            margin-top: 16px;
            background: #0a95ff;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
        }

        .submit-button:hover {
            background: #0074cc;
        }
        /* Let pre control colors; keep HLJS transparent inside blocks */
        pre code.hljs,
        .question-body code.hljs,
        .answer-body code.hljs {
          background: transparent;
          color: inherit;
        }

        /* RESPONSIVE BREAKPOINTS */
        @media (max-width: 1200px) {
            .question-container { gap: 16px; grid-template-columns: minmax(0,1fr) 260px; }
            .sidebar { width: 260px; flex: 0 0 260px; }
        }

        @media (max-width: 980px) {
            .question-body-container { flex-direction: column; gap: 12px; }
            .vote-col { flex-direction: row; width: auto; justify-content: flex-start; gap: 8px; padding: 0; }
            .question-container { grid-template-columns: 1fr; grid-template-areas: "main" "side"; gap: 20px; }
            .sidebar { width: auto; flex: none; position: static; top: auto; max-height: none; overflow: visible; }
            .question-title { font-size: 24px; }
            .question-meta { gap: 12px; }
        }

        @media (max-width: 640px) {
            .question-title {
                font-size: 20px;
            }

            .question-meta {
                flex-direction: column;
                gap: 8px;
            }

            .tag-list {
                gap: 4px;
            }

            .post-actions {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 8px;
            }

            .question-body pre {
                font-size: 12px;
                padding: 8px;
            }
        }

    </style>
</head>

<body>
<!-- Include navbar fragment from layout -->
<div th:replace="fragments/layout :: navbar"></div>
<!-- Include left sidebar fragment from layout -->
<div th:replace="fragments/layout :: sidebar"></div>

<!-- Main content area using layout's page-wrapper -->
<div class="page-wrapper">
    <div class="question-container">
        <div class="question-main">
            <!-- Title and meta info first -->
            <h1 class="question-title" th:text="${question.title}">Question Title</h1>

            <div class="question-meta">
                <span>
                    <span>Asked:</span>
                    <time th:text="${#temporals.format(question.createdAt, 'yyyy-MM-dd HH:mm')}">2025-10-23 17:52</time>
                </span>
                <span th:if="${question.updatedAt != null}">
                    <span>Modified:</span>
                    <time th:text="${#temporals.format(question.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-10-23 18:00</time>
                </span>
                <span>
                    <span>Viewed:</span>
                    <span th:text="${question.viewCount}">123</span> <span>times</span>
                </span>
            </div>

            <!-- Question body with voting buttons on the side -->
            <div class="question-body-container">
                <!-- Left voting column -->
                <div class="vote-col">
                    <form th:action="@{/questions/vote/{id}(id=${question.id})}" method="post">
                        <input type="hidden" name="choice" value="upvote" />
                        <button type="submit" class="vote-button" title="This question is useful">
                            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 18 18">
                                <path d="M1 12h16L9 4 1 12Z"/>
                            </svg>
                        </button>
                    </form>

                    <div class="vote-count" th:text="${question.score}">0</div>

                    <form th:action="@{/questions/vote/{id}(id=${question.id})}" method="post">
                        <input type="hidden" name="choice" value="downvote" />
                        <button type="submit" class="vote-button" title="This question is not useful">
                            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 18 18">
                                <path d="M1 6h16L9 14 1 6Z"/>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- Question body content -->
                <article class="question-body" th:utext="${questionHtml}">
                    <p>Question body content...</p>
                </article>
            </div>

            <div class="tag-list">
                <span th:each="tag : ${question.tags}" th:text="${tag.name}" class="tag">
                </span>
            </div>

            <div class="post-actions">
                <button type="button" class="btn btn-outline">Follow</button>
                <button type="button" class="btn btn-outline">Share</button>
                <form th:action="@{/questions/edit/{id}(id=${question.id})}" method="get" style="display:inline">
                    <button type="submit" class="btn btn-outline">Edit</button>
                </form>
                <form th:action="@{/questions/{id}(id=${question.id})}" method="post"
                      style="display:inline">
                    <input type="hidden" name="_method" value="delete" />
                    <button type="submit" class="btn btn-outline">Delete</button>
                </form>
            </div>

            <!-- Answers will be listed here -->

            <div class="answer-form">
                <h3>Your Answer</h3>
                <form th:action="@{/answers/new}" method="post" onsubmit="prepareNewAnswerContent()">
                    <input type="hidden" name="questionId" th:value="${question.id}" />
                    <div id="new-answer-editor"></div>
                    <input type="hidden" name="content" id="newAnswerContent" />
                    <button type="submit" class="submit-button">Post Your Answer</button>
                </form>
            </div>
        </div>

        <aside class="sidebar">
            <div class="card">
                <h4>Steps to write a good question</h4>
                <ul>
                    <li>Summarize the problem clearly.</li>
                    <li>Describe what you've tried.</li>
                    <li>Show minimal reproducible code.</li>
                    <li>Include expected vs actual results.</li>
                </ul>
            </div>

            <div class="card">
                <h4>Related Questions</h4>
                <ul>
                    <li><a href="#">How to handle responsive layouts</a></li>
                    <li><a href="#">CSS Flexbox best practices</a></li>
                    <li><a href="#">Mobile-first design patterns</a></li>
                </ul>
            </div>
        </aside>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script>
    const newAnswerEditor = new toastui.Editor({
        el: document.querySelector('#new-answer-editor'),
        height: '300px',
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        placeholder: 'Write your answer here...',
        usageStatistics: false,
        linkify: false,
        toolbarItems: [
            ['heading', 'bold', 'italic', 'strike'],
            ['hr'],
            ['quote', 'ul', 'ol', 'task'],
            ['table', 'image', 'link'],
            ['code', 'codeblock']
        ],
        hooks: {
            addImageBlobHook: async (blob, callback) => {
                const formData = new FormData();
                formData.append('image', blob);

                const response = await fetch('/api/images/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                callback(data.url, 'image');
            }
        }
    });

    // Note: answer form uses onsubmit=prepareNewAnswerContent() below

    function prepareNewAnswerContent(){
        document.getElementById('newAnswerContent').value = newAnswerEditor.getMarkdown();
        return true;
    }
</script>

<!-- Include footer fragment from layout -->
<div th:replace="fragments/layout :: footer"></div>
</body>
</html>
