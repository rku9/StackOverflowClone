<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${question.title}">Question Details</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-dark.min.css">

    <!-- Include layout styles first -->
    <th:block th:replace="fragments/layout :: styles"></th:block>

    <style>
        .page-wrapper {
            max-width: 1264px;
            margin: 0 auto !important;
            padding: calc(var(--navbar-height) + 20px) 16px 24px;
            box-sizing: border-box;
        }

        .question-container {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 300px;
            grid-template-areas: "main side";
            gap: 24px;
            width: 100%;
            margin: 0;
            align-items: start;
        }

        .question-main {
            flex: 1;
            min-width: 0; /* CRITICAL FIX: Allow flex item to shrink */
            word-wrap: break-word;
            grid-area: main;
        }

        .question-title {
            font-size: 27px;
            font-weight: 400;
            line-height: 1.35;
            margin: 0 0 16px 0;
            color: #3b4045;
            word-break: break-word;
        }

        .question-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #6a737c;
            padding: 8px 0;
            border-bottom: 1px solid #e3e6e8;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* Question body with voting - side by side */
        .question-body-container {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        /* Left voting column */
        .vote-col {
            width: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 4px;
            user-select: none;
            flex-shrink: 0;
        }

        .vote-button {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 2px solid #bbc0c4;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            margin: 2px 0;
        }

        .vote-button:hover {
            background: #f8f9f9;
        }

        .vote-button svg {
            fill: #848d95;
        }

        .vote-button:hover svg {
            fill: #525960;
        }

        .vote-count {
            margin: 8px 0;
            font-weight: 600;
            font-size: 21px;
            color: #6a737c;
            text-align: center;
        }

        /* Question body content */
        .question-body {
            flex: 1;
            min-width: 0; /* CRITICAL FIX: Allow flex item to shrink */
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Ensure all direct children respect the container */
        .question-body > * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Fix for editor-generated content */
        .question-body .toastui-editor-contents,
        .answer-body .toastui-editor-contents {
            max-width: 100%;
        }

        /* Strengthen image constraints */
        .question-body img,
        .answer-body img {
            max-width: 100% !important;
            width: auto !important;
            height: auto;
            display: block;
            margin: 15px 0;
            border-radius: 4px;
        }

        /* Fix for wide tables */
        .question-body table,
        .answer-body table {
            max-width: 100%;
            overflow-x: auto;
            display: block;
            box-sizing: border-box;
        }

        /* CODE BLOCKS — clearer, larger, exact whitespace */
        .question-body pre,
        .answer-body pre {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 16px 18px;
            margin: 12px 0;
            overflow: auto;
            white-space: pre; /* preserve exact spaces & newlines */
            line-height: 1.55;
            font-size: 14px;
            tab-size: 4;
            max-width: 100%;
            box-sizing: border-box;
            font-family: "Fira Code", "Source Code Pro", Consolas, monospace;
        }

        /* Inline code (not inside pre) */
        .question-body code,
        .answer-body code {
            font-family: "Fira Code", "Source Code Pro", Consolas, monospace;
            white-space: pre-wrap;
            background: #f3f4f6;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 12.5px;
            color: #2f3337;
        }

        .question-body pre code,
        .answer-body pre code {
            background: transparent;
            color: inherit;
            padding: 0;
            white-space: pre;
        }

        /* Restore list bullets and indentation in rendered content */
        .question-body ul,
        .answer-body ul {
            list-style: disc;
            margin-left: 1.25rem;
            padding-left: 1.25rem;
        }

        .question-body ol,
        .answer-body ol {
            list-style: decimal;
            margin-left: 1.25rem;
            padding-left: 1.25rem;
        }

        .question-body li,
        .answer-body li {
            margin: 6px 0;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }

        .tag {
            background: #e1ecf4;
            color: #39739d;
            border: 1px solid #cde9fe;
            padding: 4px 6px;
            font-size: 12px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .post-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 12px 0 20px 0;
            flex-wrap: wrap;
        }

        .answers-header {
            font-size: 21px;
            margin: 24px 0 12px 0;
        }

        .answer {
            border-top: 1px solid #e3e6e8;
            padding-top: 16px;
            margin-top: 16px;
        }

        /* Right sidebar styles */
        .sidebar {
            width: 300px;
            flex: 0 0 300px;
            position: sticky;
            top: calc(var(--navbar-height) + 20px);
            height: fit-content;
            max-height: calc(100vh - var(--navbar-height) - 40px);
            overflow-y: auto;
            grid-area: side;
        }

        .card {
            border: 1px solid #e3e6e8;
            border-radius: 6px;
            background: #fff;
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .card h4 {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .card ul {
            padding-left: 18px;
            margin: 0;
        }

        .card li {
            margin: 6px 0;
            line-height: 1.4;
            color: #3b4045;
            font-size: 13px;
        }

        /* Form styling */
        .answer-form {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e3e6e8;
            width: 100%;
            grid-column: 1; /* Force it to stay in first column */
            max-width: 100%;
        }

        .answer-form h3 {
            margin-bottom: 16px;
            font-size: 19px;
            color: #3b4045;
        }

        .submit-button {
            margin-top: 16px;
            background: #0a95ff;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
        }

        .submit-button:hover {
            background: #0074cc;
        }

        /* Let pre control colors; keep HLJS transparent inside blocks */
        pre code.hljs,
        .question-body code.hljs,
        .answer-body code.hljs {
            background: transparent;
            color: inherit;
        }

        /* Comment Styles */
        .comments-section {
            border-top: 1px solid #e3e6e8;
            padding-top: 12px;
            margin-top: 12px;
        }

        .comments-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .comments-container::-webkit-scrollbar {
            width: 8px;
        }

        .comments-container::-webkit-scrollbar-track {
            background: #f1f2f3;
            border-radius: 4px;
        }

        .comments-container::-webkit-scrollbar-thumb {
            background: #c8ccd0;
            border-radius: 4px;
        }

        .comments-container::-webkit-scrollbar-thumb:hover {
            background: #9fa6ad;
        }

        .comment-item {
            padding: 6px 0;
            border-bottom: 1px solid #f1f2f3;
            font-size: 13px;
            color: #232629;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-body {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6a737c;
            font-size: 12px;
        }

        .comment-author {
            color: #0077cc;
            text-decoration: none;
        }

        .comment-author:hover {
            color: #0a95ff;
        }

        .comment-date {
            color: #9199a1;
        }

        .comment-actions {
            display: flex;
            gap: 8px;
        }

        .comment-action-btn {
            background: none;
            border: none;
            color: #838c95;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
        }

        .comment-action-btn:hover {
            color: #0077cc;
        }

        .comment-edit-form {
            display: none;
            margin-top: 4px;
        }

        .comment-edit-form.active {
            display: block;
        }

        .comment-edit-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #bbc0c4;
            border-radius: 3px;
            font-size: 13px;
            font-family: inherit;
            margin-bottom: 4px;
        }

        .comment-edit-actions {
            display: flex;
            gap: 4px;
        }

        .comment-edit-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .comment-save-btn {
            background: #0a95ff;
            color: white;
        }

        .comment-save-btn:hover {
            background: #0077cc;
        }

        .comment-cancel-btn {
            background: #e4e6e8;
            color: #3b4045;
        }

        .comment-cancel-btn:hover {
            background: #d6d9dc;
        }

        .add-comment-form {
            margin-top: 12px;
        }

        .comment-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #bbc0c4;
            border-radius: 3px;
            font-size: 13px;
            font-family: inherit;
            margin-bottom: 8px;
            resize: vertical;
            min-height: 60px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #6cbbf7;
            box-shadow: 0 0 0 4px rgba(0, 149, 255, 0.15);
        }

        .comment-submit-btn {
            background: #0a95ff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
        }

        .comment-submit-btn:hover {
            background: #0077cc;
        }

        .add-comment-link {
            color: #838c95;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
        }

        .add-comment-link:hover {
            color: #0077cc;
        }

        .hidden {
            display: none;
        }

        /* RESPONSIVE BREAKPOINTS */
        @media (max-width: 1200px) {
            .question-container {
                gap: 16px;
                grid-template-columns: minmax(0, 1fr) 260px;
            }

            .sidebar {
                width: 260px;
                flex: 0 0 260px;
            }
        }

        @media (max-width: 980px) {
            .question-body-container {
                flex-direction: column;
                gap: 12px;
            }

            .vote-col {
                flex-direction: row;
                width: auto;
                justify-content: flex-start;
                gap: 8px;
                padding: 0;
            }

            .question-container {
                grid-template-columns: 1fr;
                grid-template-areas: "main" "side";
                gap: 20px;
            }

            .sidebar {
                width: auto;
                flex: none;
                position: static;
                top: auto;
                max-height: none;
                overflow: visible;
            }

            .question-title {
                font-size: 24px;
            }

            .question-meta {
                gap: 12px;
            }
        }

        @media (max-width: 640px) {
            .question-title {
                font-size: 20px;
            }

            .question-meta {
                flex-direction: column;
                gap: 8px;
            }

            .tag-list {
                gap: 4px;
            }

            .post-actions {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 8px;
            }

            .question-body pre {
                font-size: 12px;
                padding: 8px;
            }
        }

    </style>
</head>

<body>
<!-- Include navbar fragment from layout -->
<div th:replace="fragments/layout :: navbar"></div>
<!-- Include left sidebar fragment from layout -->
<div th:replace="fragments/layout :: sidebar"></div>

<!-- Main content area using layout's page-wrapper -->
<div class="page-wrapper">
    <div class="question-container">
        <div class="question-main" id="question-section">
            <!-- Title and meta info first -->
            <h1 class="question-title" th:text="${question.title}">Question Title</h1>

            <div class="question-meta">
                        <span>
                            <span>Asked:</span>
                            <time th:text="${#temporals.format(question.createdAt, 'yyyy-MM-dd HH:mm')}">2025-10-23 17:52</time>
                        </span>
                <span th:if="${question.updatedAt != null}">
                            <span>Modified:</span>
                            <time th:text="${#temporals.format(question.updatedAt, 'yyyy-MM-dd HH:mm')}">2025-10-23 18:00</time>
                </span>
                <span>
                            <span>Viewed:</span>
                            <span th:text="${question.viewCount}">123</span> <span>times</span>
                </span>
            </div>

            <!-- Question body with voting buttons on the side -->
            <div class="question-body-container">
                <!-- Left voting column -->
                <div class="vote-col">
                    <form th:action="@{/questions/vote/{id}(id=${question.id})}" method="post">
                        <input type="hidden" name="choice" value="upvote"/>
                        <input type="hidden" name="postType" value="question"/>
                        <button type="submit" class="vote-button" title="This question is useful">
                            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 18 18">
                                <path d="M1 12h16L9 4 1 12Z"/>
                            </svg>
                        </button>
                    </form>

                    <div class="vote-count" th:text="${question.score}">0</div>

                    <form th:action="@{/questions/vote/{id}(id=${question.id})}" method="post">
                        <input type="hidden" name="choice" value="downvote"/>
                        <input type="hidden" name="postType" value="question"/>
                        <button type="submit" class="vote-button" title="This question is not useful">
                            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 18 18">
                                <path d="M1 6h16L9 14 1 6Z"/>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- Question body content -->
                <div class="question-body">
                    <article th:utext="${questionHtml}">
                        <p>Question body content...</p>
                    </article>
                </div>
            </div>

            <div class="tag-list">
                <a th:each="tag : ${question.tags}"
                   th:href="@{/questions(tags=${tag.name})}"
                   th:text="${tag.name}"
                   class="tag"></a>
            </div>

            <div class="post-actions">
                <div sec:authorize="isAuthenticated()" style="display:inline">
                    <form th:if="${isFollowing}" th:action="@{/questions/{id}/unfollow(id=${question.id})}" method="post" style="display:inline">
                        <button type="submit" class="btn btn-outline">Unfollow</button>
                    </form>
                    <form th:if="${!isFollowing}" th:action="@{/questions/{id}/follow(id=${question.id})}" method="post" style="display:inline">
                        <button type="submit" class="btn btn-outline">Follow</button>
                    </form>
                </div>
                <div sec:authorize="!isAuthenticated()" style="display:inline">
                    <a class="btn btn-outline" th:href="@{/login}">Follow</a>
                </div>
                <button type="button" class="btn btn-outline">Share</button>
                <form th:action="@{/questions/edit/{id}(id=${question.id})}" method="get" style="display:inline"
                      sec:authorize="isAuthenticated()" th:if="${#authentication.name == question.authorEmail}">
                    <button type="submit" class="btn btn-outline">Edit</button>
                </form>
                <form th:action="@{/questions/{id}(id=${question.id})}" method="post"
                      style="display:inline"
                      sec:authorize="isAuthenticated()" th:if="${#authentication.name == question.authorEmail}">
                    <input type="hidden" name="_method" value="delete"/>
                    <button type="submit" class="btn btn-outline"
                            onclick="return confirm('Are you sure you want to delete this question?')">Delete
                    </button>
                </form>
            </div>

            <!-- Question Comments Section -->
            <div class="comments-section">
                <div class="comments-container" th:if="${question.comments != null and !question.comments.isEmpty()}">
                    <div class="comment-item" th:each="comment : ${question.comments}">
                        <div class="comment-body" th:id="'q-comment-body-' + ${comment.id}"
                             th:text="${comment.body}">Comment text here
                        </div>

                        <!-- Comment Edit Form -->
                        <div class="comment-edit-form" th:id="'q-comment-edit-' + ${comment.id}">
                            <form th:action="@{/comments/{id}/edit(id=${comment.id})}" method="post"
                                  onsubmit="return false;">
                                <input type="hidden" name="returnUrl" th:value="@{/questions/{id}(id=${question.id})}"/>
                                <textarea class="comment-edit-input" th:id="'q-comment-input-' + ${comment.id}"
                                          th:text="${comment.body}" name="content"></textarea>
                                <div class="comment-edit-actions">
                                    <button type="button" class="comment-edit-btn comment-save-btn"
                                            th:onclick="'saveQuestionComment(' + ${comment.id} + ', ' + ${question.id} + ')'">
                                        Save
                                    </button>
                                    <button type="button" class="comment-edit-btn comment-cancel-btn"
                                            th:onclick="'cancelEditComment(\'q\', ' + ${comment.id} + ')'">Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="comment-meta">
                            <span>–</span>
                            <a href="#" class="comment-author" th:text="${comment.author.name}">Username</a>
                            <span class="comment-date"
                                  th:text="${#temporals.format(comment.createdAt, 'MMM dd HH:mm')}">Oct 24 at 10:30</span>

                            <div class="comment-actions" sec:authorize="isAuthenticated()"
                                 th:if="${#authentication.name == comment.author.email}">
                                <button class="comment-action-btn"
                                        th:onclick="'editComment(\'q\', ' + ${comment.id} + ')'">edit
                                </button>
                                <form th:action="@{/questions/{qid}/comments/{cid}/delete(qid=${question.id}, cid=${comment.id})}"
                                      method="post" style="display: inline;">
                                    <button type="submit" class="comment-action-btn"
                                            onclick="return confirm('Delete this comment?')">delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Comment Form for Question -->
                <div class="add-comment-form" sec:authorize="isAuthenticated()">
                    <div th:id="'add-q-comment-link-' + ${question.id}">
                        <a class="add-comment-link"
                           th:onclick="'showAddCommentForm(\'q\', ' + ${question.id} + ')'">Add a comment</a>
                    </div>
                    <div th:id="'add-q-comment-form-' + ${question.id}" class="hidden">
                        <form th:action="@{/questions/{id}/comments(id=${question.id})}" method="post">
                            <textarea class="comment-input" name="content" placeholder="Add your comment..."
                                      required></textarea>
                            <button type="submit" class="comment-submit-btn">Add Comment</button>
                            <button type="button" class="comment-cancel-btn comment-edit-btn"
                                    th:onclick="'hideAddCommentForm(\'q\', ' + ${question.id} + ')'">Cancel
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Answers Section -->
            <div class="answers-section" style="margin-top: 32px;">
                <div th:if="${answers != null and !answers.isEmpty()}">
                    <h3 class="answers-header"
                        th:text="${answers.size()} + ' Answer' + (${answers.size()} > 1 ? 's' : '')">Answers</h3>

                    <div th:each="answer : ${answers}" class="answer" th:id="'answer-' + ${answer.answerId}">
                        <div class="question-body-container">
                            <div class="vote-col">
                                <form th:action="@{/answers/vote/{id}(id=${answer.answerId})}" method="post">
                                    <input type="hidden" name="questionId" th:value="${question.id}"/>
                                    <input type="hidden" name="choice" value="upvote"/>
                                    <input type="hidden" name="postType" value="answer"/>
                                    <button type="submit" class="vote-button" title="This answer is useful">
                                        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 18 18">
                                            <path d="M1 12h16L9 4 1 12Z"/>
                                        </svg>
                                    </button>
                                </form>

                                <div class="vote-count" th:text="${answer.score}">0</div>

                                <form th:action="@{/answers/vote/{id}(id=${answer.answerId})}" method="post">
                                    <input type="hidden" name="questionId" th:value="${question.id}"/>
                                    <input type="hidden" name="choice" value="downvote"/>
                                    <input type="hidden" name="postType" value="answer"/>
                                    <button type="submit" class="vote-button" title="This answer is not useful">
                                        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 18 18">
                                            <path d="M1 6h16L9 14 1 6Z"/>
                                        </svg>
                                    </button>
                                </form>
                            </div>

                            <div class="answer-body" th:id="'answer-body-wrapper-' + ${answer.answerId}">
                                <div th:id="'answer-display-' + ${answer.answerId}">
                                    <article th:utext="${answer.bodyHtml}">
                                        <p>Answer content...</p>
                                    </article>
                                    <input type="hidden"
                                           th:id="'answer-markdown-' + ${answer.answerId}"
                                           th:value="${answer.body}"/>

                                    <div class="answer-meta"
                                         style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">

                                        <!-- Green tick for accepted answer -->
                                        <span th:if="${answer.accepted}" style="color:green; font-size:1.6em; margin-right: 6px;" title="Accepted Answer">&#10003;</span>

                                        <div class="answer-actions" style="display: flex; gap: 8px;">
                                            <button type="button" class="btn btn-outline"
                                                    style="font-size: 13px; padding: 4px 8px;">Share
                                            </button>
                                            <button type="button"
                                                    class="btn btn-outline"
                                                    style="font-size: 13px; padding: 4px 8px;"
                                                    sec:authorize="isAuthenticated()"
                                                    th:if="${#authentication.name == answer.authorEmail}"
                                                    th:onclick="'showEditForm(' + ${answer.answerId} + ')'">Edit
                                            </button>
                                            <form th:action="@{/answers/{id}(id=${answer.answerId})}" method="post"
                                                  style="display:inline"
                                                  sec:authorize="isAuthenticated()"
                                                  th:if="${#authentication.name == answer.authorEmail}">
                                                <input type="hidden" name="questionId" th:value="${question.id}"/>
                                                <input type="hidden" name="_method" value="delete"/>
                                                <button type="submit" class="btn btn-outline"
                                                        style="font-size: 13px; padding: 4px 8px;"
                                                        onclick="return confirm('Are you sure you want to delete this answer?');">
                                                    Delete
                                                </button>
                                            </form>

                                            <!-- Accept answer button, only visible to question author and only if not accepted -->
                                            <div sec:authorize="isAuthenticated()" th:if="${#authentication.name == question.authorEmail}">
                                                <form th:action="@{/answers/accept/{id}(id=${answer.answerId})}" method="post" style="display:inline; margin-left: 6px;">
                                                    <input type="hidden" name="questionId" th:value="${question.id}" />
                                                    <button type="submit" th:if="${!answer.accepted}" class="btn btn-success"
                                                            style="font-size: 13px; padding: 4px 8px;">Accept</button>
                                                </form>
                                            </div>

                                        </div>

                                        <div class="answer-author"
                                             style="background: #d9eaf7; padding: 8px 10px; border-radius: 3px; font-size: 13px; color: #0c0d0e;">
                                            <div style="color: #6a737c; margin-bottom: 2px;">answered
                                                <time th:text="${#temporals.format(answer.createdAt, 'MMM dd, yyyy')}">
                                                    Oct 24, 2025
                                                </time>
                                            </div>
                                            <div>
                                                <a href="#" style="color: #0074cc; text-decoration: none;"
                                                   th:text="${answer.authorName}">username</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div th:id="'answer-edit-form-' + ${answer.answerId}" style="display: none;">
                                    <form th:action="@{/answers/edit/{id}(id=${answer.answerId})}"
                                          method="post"
                                          th:onsubmit="'return prepareEditAnswerContent(' + ${answer.answerId} + ')'">
                                        <input type="hidden" name="_method" value="patch"/>
                                        <input type="hidden" name="questionId" th:value="${question.id}"/>
                                        <div th:id="'edit-answer-editor-' + ${answer.answerId}"></div>
                                        <input type="hidden" name="body"
                                               th:id="'editAnswerContent-' + ${answer.answerId}"/>
                                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                                            <button type="submit" class="btn btn-outline"
                                                    style="font-size: 13px; padding: 4px 8px;">Save
                                            </button>
                                            <button type="button"
                                                    class="btn btn-outline"
                                                    style="font-size: 13px; padding: 4px 8px;"
                                                    th:onclick="'cancelEdit(' + ${answer.answerId} + ')'">Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Answer Comments Section -->
                                <div class="comments-section">
                                    <div class="comments-container"
                                         th:if="${answer.comments != null and !answer.comments.isEmpty()}">
                                        <div class="comment-item" th:each="comment : ${answer.comments}">
                                            <div class="comment-body" th:id="'a-comment-body-' + ${comment.id}"
                                                 th:text="${comment.body}">Comment text here
                                            </div>

                                            <!-- Comment Edit Form -->
                                            <div class="comment-edit-form" th:id="'a-comment-edit-' + ${comment.id}">
                                                <form th:action="@{/comments/{id}/edit(id=${comment.id})}" method="post"
                                                      onsubmit="return false;">
                                                    <input type="hidden" name="returnUrl"
                                                           th:value="@{/questions/{id}(id=${question.id})}"/>
                                                    <textarea class="comment-edit-input"
                                                              th:id="'a-comment-input-' + ${comment.id}"
                                                              th:text="${comment.body}" name="content"></textarea>
                                                    <div class="comment-edit-actions">
                                                        <button type="button" class="comment-edit-btn comment-save-btn"
                                                                th:onclick="'saveAnswerComment(' + ${comment.id} + ', ' + ${question.id} + ')'">
                                                            Save
                                                        </button>
                                                        <button type="button"
                                                                class="comment-edit-btn comment-cancel-btn"
                                                                th:onclick="'cancelEditComment(\'a\', ' + ${comment.id} + ')'">
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>

                                            <div class="comment-meta">
                                                <span>–</span>
                                                <a href="#" class="comment-author"
                                                   th:text="${comment.author.name}">Username</a>
                                                <span class="comment-date"
                                                      th:text="${#temporals.format(comment.createdAt, 'MMM dd HH:mm')}">Oct 24 at 10:30</span>

                                                <div class="comment-actions" sec:authorize="isAuthenticated()"
                                                     th:if="${#authentication.name == comment.author.email}">
                                                    <button class="comment-action-btn"
                                                            th:onclick="'editComment(\'a\', ' + ${comment.id} + ')'">
                                                        edit
                                                    </button>
                                                    <form th:action="@{/answers/{aid}/comments/{cid}/delete(aid=${answer.answerId}, cid=${comment.id})}"
                                                          method="post" style="display: inline;">
                                                        <button type="submit" class="comment-action-btn"
                                                                onclick="return confirm('Delete this comment?')">delete
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Add Comment Form for Answer -->
                                    <div class="add-comment-form" sec:authorize="isAuthenticated()">
                                        <div th:id="'add-a-comment-link-' + ${answer.answerId}">
                                            <a class="add-comment-link"
                                               th:onclick="'showAddCommentForm(\'a\', ' + ${answer.answerId} + ')'">Add
                                                a comment</a>
                                        </div>
                                        <div th:id="'add-a-comment-form-' + ${answer.answerId}" class="hidden">
                                            <form th:action="@{/answers/{id}/comments(id=${answer.answerId})}"
                                                  method="post">
                                    <textarea class="comment-input" name="content"
                                              placeholder="Add your comment..." required></textarea>
                                                <button type="submit" class="comment-submit-btn">Add Comment</button>
                                                <button type="button" class="comment-cancel-btn comment-edit-btn"
                                                        th:onclick="'hideAddCommentForm(\'a\', ' + ${answer.answerId} + ')'">
                                                    Cancel
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>

                <div th:if="${answers == null or answers.isEmpty()}"
                     style="padding: 32px; text-align: center; color: #6a737c; border-top: 1px solid #e3e6e8;">
                    <p style="font-size: 15px; margin: 0;">No answers yet. Be the first to answer!</p>
                </div>
            </div>

            <div class="answer-form" sec:authorize="isAuthenticated()">
                <h3>Your Answer</h3>
                <form id="new-answer-form" th:action="@{/answers/new}" method="post"
                      onsubmit="return prepareNewAnswerContent()">
                    <input type="hidden" name="questionId" th:value="${question.id}"/>
                    <div id="new-answer-editor"></div>
                    <input type="hidden" name="body" id="newAnswerContent"/>
                    <button type="submit" class="submit-button">Post Your Answer</button>
                </form>
            </div>
            <div sec:authorize="!isAuthenticated()">
                <div class="login-prompt" style="background: #fdf7e7; border: 1px solid #f1e5bc; padding: 5px; border-radius: 5px; text-align: center;">
                    <p style="margin: 0 0 12px 0; font-size: 15px; color: #3b4045;">
                        You must be logged in to post an answer.
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <a th:href="@{/login}" class="btn" style="background: #0a95ff; color: white; padding: 10px 16px; text-decoration: none; border-radius: 3px;">
                            Log in
                        </a>
                        <a th:href="@{/signup}" class="btn" style="background: #fff; color: #0a95ff; padding: 10px 16px; text-decoration: none; border-radius: 3px; border: 1px solid #0a95ff;">
                            Sign up
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="fragments/layout :: footer"></div>
<script th:replace="fragments/layout :: navbar-script"></script>

<!-- Highlight.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<!-- Toast UI Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>

    // NEW ANSWER EDITOR

    const newAnswerEditor = new toastui.Editor({
        el: document.querySelector('#new-answer-editor'),
        height: '300px',
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        placeholder: 'Write your answer here...',
        usageStatistics: false,
        linkify: false,
        toolbarItems: [
            ['heading', 'bold', 'italic', 'strike'],
            ['hr'],
            ['quote', 'ul', 'ol', 'task'],
            ['table', 'image', 'link'],
            ['code', 'codeblock']
        ],
        hooks: {
            addImageBlobHook: async (blob, callback) => {
                const fd = new FormData();
                fd.append('image', blob, blob?.name || 'image.png');

                const resp = await fetch('/api/images/upload', {method: 'POST', body: fd});
                if (!resp.ok) {
                    let msg = 'Image upload failed';
                    try {
                        const err = await resp.json();
                        if (err?.error) msg = err.error;
                    } catch {
                    }
                    alert(msg);
                    return;
                }
                const data = await resp.json();
                if (!data?.url) {
                    alert('Upload succeeded but no URL returned');
                    return;
                }
                callback(data.url, 'image');
            }
        }
    });

    // Optional prefill for edit flow (if an element with existing markdown exists)
    (function prefillEditor() {
        const el = document.getElementById('existing-body');
        if (el) {
            const content = el.textContent || '';
            if (content.trim().length) {
                newAnswerEditor.setMarkdown(content);
            }
        }
    })();

    // Single submit hook used by onsubmit attribute
    function prepareNewAnswerContent() {
        const markdown = newAnswerEditor.getMarkdown();
        document.getElementById('newAnswerContent').value = markdown;
        return true;
    }

    // EDIT ANSWER EDITOR

    let editAnswerEditor = null;
    let currentEditingAnswerId = null;

    function initEditAnswerEditor(answerId, currentContent) {
        if (editAnswerEditor) {
            editAnswerEditor.destroy();
        }
        editAnswerEditor = new toastui.Editor({
            el: document.querySelector('#edit-answer-editor-' + answerId),
            height: '300px',
            initialEditType: 'markdown',
            previewStyle: 'vertical',
            initialValue: currentContent,
            usageStatistics: false,
            linkify: false,
            toolbarItems: [
                ['heading', 'bold', 'italic', 'strike'],
                ['hr'],
                ['quote', 'ul', 'ol', 'task'],
                ['table', 'image', 'link'],
                ['code', 'codeblock']
            ],
            hooks: {
                addImageBlobHook: async (blob, callback) => {
                    const formData = new FormData();
                    formData.append('image', blob);

                    const response = await fetch('/api/images/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    callback(data.url, 'image');
                }
            }
        });
    }

    function prepareEditAnswerContent(answerId) {
        if (!editAnswerEditor) {
            return false;
        }
        const content = editAnswerEditor.getMarkdown();
        document.getElementById('editAnswerContent-' + answerId).value = content;
        currentEditingAnswerId = null;
        return true;
    }

    function showEditForm(answerId) {
        if (currentEditingAnswerId && currentEditingAnswerId !== answerId) {
            cancelEdit(currentEditingAnswerId);
        }
        const answerDisplay = document.getElementById('answer-display-' + answerId);
        const answerEditForm = document.getElementById('answer-edit-form-' + answerId);
        const currentContent = document.getElementById('answer-markdown-' + answerId).value;

        answerDisplay.style.display = 'none';
        answerEditForm.style.display = 'block';
        initEditAnswerEditor(answerId, currentContent);
        currentEditingAnswerId = answerId;
    }

    function cancelEdit(answerId) {
        document.getElementById('answer-display-' + answerId).style.display = 'block';
        document.getElementById('answer-edit-form-' + answerId).style.display = 'none';
        if (editAnswerEditor) {
            editAnswerEditor.destroy();
            editAnswerEditor = null;
        }
        if (currentEditingAnswerId === answerId) {
            currentEditingAnswerId = null;
        }
    }

    // COMMENT FUNCTIONS

    // Show add comment form
    function showAddCommentForm(type, id) {
        document.getElementById('add-' + type + '-comment-link-' + id).classList.add('hidden');
        document.getElementById('add-' + type + '-comment-form-' + id).classList.remove('hidden');
    }

    // Hide add comment form
    function hideAddCommentForm(type, id) {
        document.getElementById('add-' + type + '-comment-form-' + id).classList.add('hidden');
        document.getElementById('add-' + type + '-comment-link-' + id).classList.remove('hidden');
    }

    // Edit comment
    function editComment(type, commentId) {
        document.getElementById(type + '-comment-body-' + commentId).classList.add('hidden');
        document.getElementById(type + '-comment-edit-' + commentId).classList.add('active');
    }

    // Cancel edit comment
    function cancelEditComment(type, commentId) {
        document.getElementById(type + '-comment-body-' + commentId).classList.remove('hidden');
        document.getElementById(type + '-comment-edit-' + commentId).classList.remove('active');
    }

    // Save question comment
    function saveQuestionComment(commentId, questionId) {
        const content = document.getElementById('q-comment-input-' + commentId).value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/comments/' + commentId + '/edit';

        const contentInput = document.createElement('input');
        contentInput.type = 'hidden';
        contentInput.name = 'content';
        contentInput.value = content;

        const returnUrlInput = document.createElement('input');
        returnUrlInput.type = 'hidden';
        returnUrlInput.name = 'returnUrl';
        returnUrlInput.value = '/questions/' + questionId;

        form.appendChild(contentInput);
        form.appendChild(returnUrlInput);
        document.body.appendChild(form);
        form.submit();
    }

    // Save answer comment
    function saveAnswerComment(commentId, questionId) {
        const content = document.getElementById('a-comment-input-' + commentId).value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/comments/' + commentId + '/edit';

        const contentInput = document.createElement('input');
        contentInput.type = 'hidden';
        contentInput.name = 'content';
        contentInput.value = content;

        const returnUrlInput = document.createElement('input');
        returnUrlInput.type = 'hidden';
        returnUrlInput.name = 'returnUrl';
        returnUrlInput.value = '/questions/' + questionId;

        form.appendChild(contentInput);
        form.appendChild(returnUrlInput);
        document.body.appendChild(form);
        form.submit();
    }
</script>
</body>
</html>
