<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>StackOverflow Clone â€“ Questions</title>
    <th:block th:replace="~{fragments/layout :: styles}"></th:block>
    <style>
        .pagination-container a:hover {
            background: #f8f9f9 !important;
            border-color: #bbc0c4 !important;
        }

        .pagination-number:hover {
            background: #e1ecf4 !important;
        }

        /* Tab navigation styles */
        .tab-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid #9fa6ad;
            padding: 8px 12px;
            font-size: 13px;
            color: #6a737c;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #f8f9f9;
        }

        .tab-btn.active {
            background: #e3e6e8;
            color: #3b4045;
            font-weight: 500;
        }

        /* Filter button */
        .filter-btn {
            background: transparent;
            border: 1px solid #9fa6ad;
            color: #6a737c;
            padding: 8px 10px;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .filter-btn:hover {
            background: #f8f9f9;
        }

        /* Modal overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Modal content */
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #d6d9dc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #232629;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #d6d9dc;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            color: #6a737c;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Filter sections */
        .filter-section {
            margin-bottom: 24px;
        }

        .filter-section h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #232629;
            font-weight: 600;
        }

        .filter-section label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #3b4045;
            cursor: pointer;
        }

        .filter-section input[type="radio"],
        .filter-section input[type="checkbox"] {
            margin-right: 6px;
        }

        .filter-section input[type="number"] {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #babfc4;
            border-radius: 3px;
            font-size: 13px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/layout :: navbar}"></div>
<div th:replace="~{fragments/layout :: sidebar}"></div>
<div class="page-wrapper">
    <main>
        <!-- Header with title and Ask Question button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h1 style="font-size: 27px; font-weight: 400;">All Questions</h1>
            <a th:href="@{/questions/new}"
               style="background: #0a95ff; color: white; text-decoration: none; padding: 10px 16px; border-radius: 4px; font-size: 13px;">
                Ask Question
            </a>
        </div>

        <!-- Question count and sorting/filter controls -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #d6d9dc;">
            <div style="font-size: 17px; color: #232629;"
                 th:text="${#lists.size(questionResponseDtoList)} + ' questions'">
                0 questions
            </div>
            <div style="display: flex; gap: 12px;">
                <!-- Sort Buttons (3 visible) -->
                <div class="tab-nav">
                    <button class="tab-btn"
                            th:classappend="${param.sort == null or param.sort[0] == 'Newest'} ? 'active'"
                            onclick="changeSort('Newest')">Newest
                    </button>
                    <button class="tab-btn"
                            th:classappend="${param.sort != null and param.sort[0] == 'HighestScore'} ? 'active'"
                            onclick="changeSort('HighestScore')">Highest Score
                    </button>
                    <button class="tab-btn"
                            th:classappend="${param.sort != null and param.sort[0] == 'MostAnswers'} ? 'active'"
                            onclick="changeSort('MostAnswers')">Most Answers
                    </button>
                </div>

                <!-- Filter Button (with More functionality) -->
                <button class="filter-btn" onclick="openFilterModal()">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                        <path d="M0 1h4v2H0V1zm6 0h8v2H6V1zM0 6h8v2H0V6zm10 0h4v2h-4V6zM0 11h4v2H0v-2zm6 0h8v2H6v-2z"/>
                    </svg>
                    Filter
                </button>
            </div>
        </div>

        <!-- Questions List -->
        <div class="questions-list" style="display: flex; flex-direction: column; gap: 16px;">
            <div th:each="question : ${questionResponseDtoList}" class="question-summary"
                 style="border-bottom: 1px solid #e3e6e8; padding: 16px 0; display: flex; gap: 16px;">
                <!-- Stats -->
                <div style="width: 108px; display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: #6a737c;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span th:text="${question.score}" style="font-weight: 500;">0</span>
                        <span>votes</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span th:text="${question.answerCount}" style="font-weight: 500;">0</span>
                        <span>answers</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span th:text="${question.viewCount}" style="font-weight: 500;">0</span>
                        <span>views</span>
                    </div>
                </div>

                <!-- Main Content -->
                <div style="flex: 1;">
                    <h3 style="margin-bottom: 8px;">
                        <a th:href="@{'/questions/' + ${question.id}}" th:text="${question.title}"
                           style="color: #0074cc; text-decoration: none; font-size: 17px; line-height: 1.3;"></a>
                    </h3>
                    <div th:utext="${#strings.abbreviate(question.body, 200)}"
                         style="margin-bottom: 8px; color: #3b4045; font-size: 13px; line-height: 1.4;">
                        <!-- question excerpt -->
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <a th:each="tag : ${question.tags}"
                               th:href="@{/questions(tags=${tag.name})}"
                               th:text="${tag.name}"
                               style="display: inline-block; background: #e1ecf4; color: #39739d; border-radius: 3px; padding: 4px 6px; font-size: 12px; margin-right: 4px; text-decoration: none;">
                            </a>
                        </div>
                        <div style="font-size: 12px; color: #6a737c; display: flex; align-items: center; gap: 8px;">
                            <img th:if="${question.authorProfileImageUrl != null}" th:src="${question.authorProfileImageUrl}"
                                 alt="avatar" style="width: 24px; height: 24px; border-radius: 3px; object-fit: cover;">
                            <div th:if="${question.authorProfileImageUrl == null}"
                                 style="width: 24px; height: 24px; border-radius: 3px; background: #e1ecf4; color: #39739d; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                <span th:text="${#strings.substring(question.authorName, 0, 1)}">U</span>
                            </div>
                            <div>
                                <a th:href="@{'/users/' + ${question.authorId}}" th:text="${question.authorName}"
                                   style="color: #0074cc; text-decoration: none; font-weight: 500;"></a>
                                <span>asked</span>
                                <span th:text="${#temporals.format(question.createdAt, 'MMM dd, yyyy')}">Oct 24, 2025</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div th:if="${totalPages > 1}" class="pagination-container"
             style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 32px; padding: 20px 0;">

            <!-- Previous Button -->
            <a th:if="${currentPage > 0}"
               th:href="@{/questions(page=${currentPage - 1}, size=15, q=${query}, sort=${sort}, filters=${filters}, daysOld=${daysOld}, tags=${tags})}"
               class="pagination-btn"
               style="padding: 8px 12px; border: 1px solid #d6d9dc; border-radius: 3px; text-decoration: none; color: #3b4045; background: white;">
                Prev
            </a>
            <span th:if="${currentPage == 0}"
                  style="padding: 8px 12px; border: 1px solid #e3e6e8; border-radius: 3px; color: #bbc0c4; background: #f8f9f9;">
        Prev
    </span>

            <!-- Page Numbers -->
            <div style="display: flex; gap: 4px;">
                <!-- First page -->
                <a th:if="${currentPage > 2}"
                   th:href="@{/questions(page=0, size=15, q=${query}, sort=${sort}, filters=${filters}, daysOld=${daysOld}, tags=${tags})}"
                   class="pagination-number"
                   style="padding: 8px 12px; border: 1px solid #d6d9dc; border-radius: 3px; text-decoration: none; color: #3b4045; background: white;">
                    1
                </a>

                <!-- Ellipsis if needed -->
                <span th:if="${currentPage > 3}" style="padding: 8px 4px;">...</span>

                <!-- Pages around current page -->
                <th:block th:each="i : ${#numbers.sequence(currentPage > 2 ? currentPage - 1 : 0,
                                                   currentPage < totalPages - 3 ? currentPage + 1 : totalPages - 1)}">
                    <a th:if="${i != currentPage}"
                       th:href="@{/questions(page=${i}, size=15, q=${query}, sort=${sort}, filters=${filters}, daysOld=${daysOld}, tags=${tags})}"
                       th:text="${i + 1}"
                       class="pagination-number"
                       style="padding: 8px 12px; border: 1px solid #d6d9dc; border-radius: 3px; text-decoration: none; color: #3b4045; background: white;">
                    </a>
                    <span th:if="${i == currentPage}"
                          th:text="${i + 1}"
                          style="padding: 8px 12px; border: 1px solid #0a95ff; border-radius: 3px; color: white; background: #0a95ff; font-weight: 500;">
            </span>
                </th:block>

                <!-- Ellipsis if needed -->
                <span th:if="${currentPage < totalPages - 4}" style="padding: 8px 4px;">...</span>

                <!-- Last page -->
                <a th:if="${currentPage < totalPages - 3}"
                   th:href="@{/questions(page=${totalPages - 1}, size=15, q=${query}, sort=${sort}, filters=${filters}, daysOld=${daysOld}, tags=${tags})}"
                   th:text="${totalPages}"
                   class="pagination-number"
                   style="padding: 8px 12px; border: 1px solid #d6d9dc; border-radius: 3px; text-decoration: none; color: #3b4045; background: white;">
                </a>
            </div>

            <!-- Next Button -->
            <a th:if="${currentPage < totalPages - 1}"
               th:href="@{/questions(page=${currentPage + 1}, size=15, q=${query}, sort=${sort}, filters=${filters}, daysOld=${daysOld}, tags=${tags})}"
               class="pagination-btn"
               style="padding: 8px 12px; border: 1px solid #d6d9dc; border-radius: 3px; text-decoration: none; color: #3b4045; background: white;">
                Next
            </a>
            <span th:if="${currentPage == totalPages - 1}"
                  style="padding: 8px 12px; border: 1px solid #e3e6e8; border-radius: 3px; color: #bbc0c4; background: #f8f9f9;">
        Next
    </span>
        </div>

        <!-- Pagination Info -->
        <div th:if="${totalPages > 0}"
             style="text-align: center; margin-top: 16px; font-size: 13px; color: #6a737c;">
            Showing <span th:text="${currentPage * 15 + 1}">1</span> -
            <span th:text="${(currentPage + 1) * 15 > totalItems ? totalItems : (currentPage + 1) * 15}">15</span>
            of <span th:text="${totalItems}">100</span> questions
        </div>

    </main>
</div>

<!-- Combined Sort & Filter Modal -->
<div id="filterModal" class="modal-overlay" onclick="closeFilterModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>Sort and Filter</h3>
            <button class="close-btn" onclick="closeFilterModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Sort Section -->
            <div class="filter-section">
                <h4>Sorted by</h4>
                <label><input type="radio" name="sortOption" value="Newest" checked> Newest</label>
                <label><input type="radio" name="sortOption" value="Oldest"> Oldest</label>
                <label><input type="radio" name="sortOption" value="HighestScore"> Highest Score</label>
                <label><input type="radio" name="sortOption" value="MostAnswers"> Most Answers</label>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <h4>Filter by</h4>
                <label>
                    <input type="checkbox" id="filterNoAnswers" value="NoAnswers">
                    No answers
                </label>
                <label>
                    <input type="checkbox" id="filterNoAccepted" value="NoUpvotedOrAccepted">
                    No upvoted or accepted answers
                </label>
            </div>

            <div class="filter-section">
                <h4>Question Age</h4>
                <label for="daysOld">Days old (minimum):</label>
                <input type="number" id="daysOld" name="daysOld" min="0" placeholder="e.g., 7"
                       style="width: 100%; padding: 6px 10px; border: 1px solid #babfc4; border-radius: 3px; font-size: 13px;">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="clearFilters()"
                    style="padding: 8px 12px; border: 1px solid #9fa6ad; background: white; color: #6a737c; border-radius: 3px; cursor: pointer;">
                Clear
            </button>
            <button onclick="closeFilterModal()"
                    style="padding: 8px 12px; border: 1px solid #9fa6ad; background: white; color: #6a737c; border-radius: 3px; cursor: pointer;">
                Cancel
            </button>
            <button onclick="applyFilters()"
                    style="padding: 8px 12px; border: none; background: #0a95ff; color: white; border-radius: 3px; cursor: pointer;">
                Apply
            </button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/layout :: footer}"></div>

<script th:replace="~{fragments/layout :: navbar-script}"></script>
<script>
    // On page load, restore sort and filter values from URL
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const sort = urlParams.get('sort') || 'Newest';
        const filters = urlParams.getAll('filters'); // Get all filter parameters
        const daysOld = urlParams.get('daysOld');

        // Restore sort selection
        const sortRadio = document.querySelector(`input[name="sortOption"][value="${sort}"]`);
        if (sortRadio) sortRadio.checked = true;

        // Restore filter checkboxes
        if (filters.length > 0) {
            filters.forEach(filter => {
                if (filter === 'NoAnswers') {
                    document.getElementById('filterNoAnswers').checked = true;
                } else if (filter === 'NoUpvotedOrAccepted') {
                    document.getElementById('filterNoAccepted').checked = true;
                }
            });
        }

        // Restore days old
        if (daysOld) {
            document.getElementById('daysOld').value = daysOld;
        }
    });

    function changeSort(sortType) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort', sortType);
        window.location.search = urlParams.toString();
    }

    function openFilterModal() {
        document.getElementById('filterModal').classList.add('show');
    }

    function closeFilterModal(event) {
        if (!event || event.target.classList.contains('modal-overlay')) {
            document.getElementById('filterModal').classList.remove('show');
        }
    }

    function clearFilters() {
        // Clear sort - reset to Newest
        document.querySelector('input[name="sortOption"][value="Newest"]').checked = true;

        // Clear filters
        document.getElementById('filterNoAnswers').checked = false;
        document.getElementById('filterNoAccepted').checked = false;
        document.getElementById('daysOld').value = '';
    }

    function applyFilters() {
        const urlParams = new URLSearchParams(window.location.search);

        // Get selected sort
        const selectedSort = document.querySelector('input[name="sortOption"]:checked').value;
        urlParams.set('sort', selectedSort);

        // Remove all existing filter parameters
        urlParams.delete('filters');

        // Add each filter as a separate parameter
        if (document.getElementById('filterNoAnswers').checked) {
            urlParams.append('filters', 'NoAnswers');
        }
        if (document.getElementById('filterNoAccepted').checked) {
            urlParams.append('filters', 'NoUpvotedOrAccepted');
        }

        // Add days old parameter
        const daysOld = document.getElementById('daysOld').value;
        if (daysOld && daysOld > 0) {
            urlParams.set('daysOld', daysOld);
        } else {
            urlParams.delete('daysOld');
        }

        window.location.search = urlParams.toString();
    }
</script>
</body>
</html>
